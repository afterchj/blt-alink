<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tpadsz.after.dao.PlaceDao">

    <select id="getLastPlace" resultType="integer">
        select place_id from alink.f_place where mid=(select id from alink.f_mesh where mesh_id=#{meshId}) and uid=#{uid} order by place_id desc limit 1
    </select>

    <insert id="savePlace" useGeneratedKeys="true" keyProperty="id" parameterType="com.tpadsz.after.entity.PlaceSave">
        insert into alink.f_place (place_id,pname,uid,mid,create_date,update_date)
        VALUES(#{placeId},#{pname},#{uid},(select id from alink.f_mesh where mesh_id=#{meshId}),now(),now())
    </insert>

    <select id="getPname" resultType="integer">
        select count(*) from alink.f_place where mid=(select id from alink.f_mesh where mesh_id=#{meshId}) and uid=#{uid} and pname=#{pname}
    </select>

    <delete id="deletePlaceByPid">
        DELETE FROM alink.f_place where id=#{pid}
    </delete>

    <update id="updatePname">
        update alink.f_place set pname=#{pname} where id=#{pid}
    </update>

    <select id="getPlaceByMeshId" resultType="map">
        select id as pid,mid from alink.f_place where mid=(select id from alink.f_mesh where mesh_id=#{meshId} and uid=#{uid})
    </select>

    <resultMap id="placeList" type="com.tpadsz.after.entity.PlaceExtend">
        <id column="id" property="id"/>
        <result column="pname" property="pname"/>
        <result column="place_id" property="placeId"/>
        <collection property="groupList" ofType="com.tpadsz.after.entity.GroupList">
            <id property="id" column="id"/>
            <!--property实体类中定义的属性 column数据库中字段名-->
            <result property="groupId" column="group_id"/>
            <result property="gname" column="gname"/>
            <!-- property指的是在bean中字段名 ofType类的全定向名 -->
            <!--一对多-->
            <collection property="lightLists" ofType="com.tpadsz.after.entity.LightList">
                <id property="lid" column="lid"/>
                <result property="lmac" column="lmac"/>
                <result property="lname" column="lname"/>
                <result property="productId" column="product_id"/>
            </collection>
        </collection>
    </resultMap>


    <select id="getPlacesAndGroups" resultMap="placeList">
        select
            p.id,p.place_id,p.pname,
    	    g.id,
        	g.group_id,
        	g.gname,
        	l.id as lid,
        	l.lmac,
        	l.lname,
        	l.product_id
        from alink.f_place p left join alink.f_group g on p.id=g.pid
        left join alink.f_light l on g.id=l.gid
        where p.mid=#{mid}
        order by place_id,group_id
    </select>

    <select id="getPlaceByPlaceIdAndMeshId" resultType="string">
        select pname from alink.f_place where mid=(SELECT id FROM alink.f_mesh WHERE mesh_id = #{meshId}) and
                                            place_id=#{placeId}
    </select>
</mapper>